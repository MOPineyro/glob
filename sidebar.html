<link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons.css">
<!-- The CSS package above applies Google styling to buttons and other elements. -->

<style>

h3 {
  padding:10px 0;
  display: table-cell;
}

.branding-below {
  bottom:54px;
  top:0;
}

.branding-text {
  left:7px;
  position:relative;
  top:3px
}

.logo {
  vertical-align:middle
}

.width-100 {
  width:100%;
  box-sizing:border-box;
  -webkit-box-sizing:border-box;
  -moz-box-sizing:border-box
}

label {
  font-weight:700;
  padding-right: 10px;
}

#creator-options,#respondent-options {
  background-color:#eee;
  border-color:#eee;
  border-width:5px;
  border-style:solid;
  display:none
}

#creator-email,#respondent-email,#button-bar {
  margin-bottom:10px
}

#response-step {
  display:inline
}

form {
  display:table
}

p {
  display:table-row
}

label {
  display:table-cell
}

input {
  display:table-cell
}

.contacts-list{
  display: none;
  }
</style>

<div class="sidebar">

  <form>
    <p><label for="api-key">API Key</label> <input class="width-100" id="api-key" style="width: 180px"></p>
   <p style="white-space:nowrap; !important;" id="import-contacts"> <a>Import Contacts</a></p>
    <h3>From</h3>
     <select class = "contacts-list">
     <option value="default">----</option>
     </select> 

    <p><label for="sender-name">Name</label> <input class="width-100" id="sender-name" style="width: 180px"><br></p>

    <p><label for="sender-address">Address</label> <input class="width-100" id="sender-address" style="width: 180px"><br></p>

    <p><label for="sender-city">City</label> <input class="width-100" id="sender-city" style="width: 180px"><br></p>

    <p><label for="sender-state">State</label> <input class="width-5" id="sender-state" style="width: 30px"></p>

    <p><label for="sender-zip">Zip</label> <input class="width-100" id="sender-zip" style="width: 60px"></p>
    <p><br></p>
    <h3>To</h3>
     <select class = "contacts-list">
     <option value="default">----</option>
     </select> 

    <p><label for="recipient-name">Name</label> <input class="width-100" id="recipient-name" style="width: 180px"></p>

    <p><label for="recipient-address">Address</label> <input class="width-100" id="recipient-address" style="width: 180px"></p>

    <p><label for="recipient-city">City</label> <input class="width-100" id="recipient-city" style="width: 180px"></p>
 
    <p><label for="recipient-state">State</label> <input class="width-100" id="recipient-state" style="width: 30px"></p>

    <p><label for="recipient-zip">Zip</label> <input class="width-100" id="recipient-zip" style="width: 60px"></p>
      </form>
    <h3>Estimated Price: <span id="estimate_btn"><a>Calculate</a></span></h3>
    <button class="action" id="send-letter">Send</button>


  <div class="block" id="button-bar"></div>
</div><script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script> <script>
  /**
   * On document load, assign required handlers to each element,
   * and attempt to load any saved settings.
   */
   
  var contacts_list;
  
  $(function() {
    $('#send-letter').click(sendLetter);
    $('#import-contacts').click(getContacts);
    $('#estimate_btn').click(estimateCost);
  });
  /**
   * Collects the options specified in the add-on sidebar and sends them to
   * be saved as Properties on the server.
   */
   
  function getContacts(){
      $("#import-contacts").html("Importing...");
      var api_key = $("#api-key").val().trim();
      google.script.run.withSuccessHandler(function(msg, element) {
      setContacts(msg);
    }).withFailureHandler(function(msg, element) {
        showStatus(msg, $('#button-bar'));
      }).withUserObject(this).getAddresses(api_key);
}
      
  
  function sendLetter() {
      $("#status").remove();
      this.disabled = true;
      var api_key = $("#api-key").val().trim();
      var from = {
        "name": $("#sender-name").val(),
        "address": $("#sender-address").val(),
        "city": $("#sender-city").val(),
        "state": $("#sender-state").val(),
        "zip": $("#sender-zip").val()
      };
      var to = {
        "name": $("#recipient-name").val(),
        "address": $("#recipient-address").val(),
        "city": $("#recipient-city").val(),
        "state": $("#recipient-state").val(),
        "zip": $("#recipient-zip").val()
      };
      if (!to.name || !to.address || !to.city || !to.state || !to.zip || !from.name || !from.address || !from.city || !from.state || !from.zip || !api_key) {
        showStatus('All fields must be filled!', $('#button-bar'));
        this.disabled = false;
        return;
      }
      var settings = {
        "apiKey": api_key,
        "fromName": from.name,
        "fromAddress": from.address,
        "fromCity": from.city,
        "fromState": from.state,
        "fromZip": from.zip,
        "toName": to.name,
        "toAddress": to.address,
        "toCity": to.city,
        "toState": to.state,
        "toZip": to.zip
      }
      google.script.run.withSuccessHandler(function(msg, element) {
        showStatus('Letter successfully sent!', $('#button-bar'));
        element.disabled = false;
      }).withFailureHandler(function(msg, element) {
        showStatus(msg, $('#button-bar'));
        element.disabled = false;
      }).withUserObject(this).saveSettingsAndSendLetter(settings);
    }
    /**
     * Inserts a div that contains an status message after a given element.
     *
     * @param {String} msg The status message to display.
     * @param {Object} element The element after which to display the Status.
     */

  function estimateCost() {
    $("#estimate_btn").html("Calculating...");
    google.script.run.withSuccessHandler(function(msg, element) {
      setCost(msg);
      element.disabled = false;
    }).withFailureHandler(function(msg, element) {
      showStatus(msg, $('#button-bar'));
      element.disabled = false;
    }).withUserObject(this).getNumberOfPages();
  }
  
  function setContacts(msg) {
      contacts_list = msg;
      $("#import-contacts").css({"visibility": "hidden"});
      $(".contacts-list").show();
      for (var j = 0; j < msg.data.length; j++) {
          $(".contacts-list").append("<option value="+j+">" + msg.data[j].name + " - " + msg.data[j].address_city + "</option>");
      }
  }

  function setCost(pages) {
    //Linear regression estimate of pages versus job price
    var estimated_price = 0.20859580519019 + 0.40689477426235 * pages;
    $("#estimate_btn").html("$" + estimated_price.toFixed(2));
  }

  function showStatus(msg, element) {
    var div = $('<div>').attr('id', 'status').attr('class', 'error').text(msg);
    $(element).after(div);
  }
</script>


